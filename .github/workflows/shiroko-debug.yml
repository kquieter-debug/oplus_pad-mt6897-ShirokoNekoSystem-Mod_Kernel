name: SukiSU-Ultra 构建 (MTK平台)
on:
  workflow_dispatch:
    inputs:
      CPU:
        type: choice
        description: "芯片平台分支"
        required: true
        default: mt6897
        options:
          - mt6897
      FEIL:
        type: choice
        description: "设备配置文件"
        required: true
        default: onepluspad
        options:
          - onepluspad
      CPUD:
        type: choice
        description: "处理器代号"
        required: true
        default: mt6897
        options:
          - mt6897
      ANDROID_VERSION:
        type: choice
        description: "Android系统版本"
        required: true
        default: android14
        options:
          - android14
          - android15
      KERNEL_VERSION:
        type: choice
        description: "Linux内核版本"
        required: true
        default: "6.1"
        options:
          - "6.1"
      BUILD_METHOD:
        type: choice
        description: "编译模式"
        required: true
        default: perf
        options:
          - gki
          - perf
      SUFFIX:
        type: string
        description: "自定义内核版本后缀 (留空使用随机生成)"
        required: false
        default: "-fuckoplus"
      VFS:
        type: boolean
        description: "启用VFS手动钩子功能"
        required: true
        default: true
      ZRAM:
        type: boolean
        description: "启用扩展ZRAM压缩算法"
        required: true
        default: true
      FAST:
        type: boolean
        description: "启用快速编译模式 (仅生成Image)"
        required: true
        default: true
      INTEGRATE_OPTION:
        type: choice
        description: "选择要集成的功能 (二选一)"
        required: true
        default: "集成 SUSFS 功能"
        options:
          - "仅集成 SukiSU-ultra"
          - "集成 SUSFS 功能"
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_DIR: /home/runner/.ccache
      CCACHE_MAXSIZE: 8G
    steps:
      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: 配置Git
        run: |
          git config --global user.name "Winkmoon"
          git config --global user.email "3432632982@qq.com"

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y python3 git curl clang cmake make llvm wget
          sudo apt-get install curl bison flex make binutils dwarves git lld pahole zip perl gcc python3 python-is-python3 bc libssl-dev libelf-dev clang wget cmake ccache -y
          
      - name: 安装LLVM工具链
        run: |
          wget https://apt.llvm.org/llvm.sh
          sudo chmod +x llvm.sh
          sudo ./llvm.sh 20 all   

      - name: 配置Rust工具链
        run: |
          rustup default nightly
          rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android i686-linux-android
          rustup component add rust-src llvm-tools-preview
          rustup update

      - name: 恢复ccache缓存
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ccache-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-
                        
      - name: 显示输入参数
        run: |
          echo "芯片平台: ${{ github.event.inputs.CPU }}"
          echo "设备配置: ${{ github.event.inputs.FEIL }}"
          echo "处理器代号: ${{ github.event.inputs.CPUD }}"
          echo "Android版本: ${{ github.event.inputs.ANDROID_VERSION }}"
          echo "内核版本: ${{ github.event.inputs.KERNEL_VERSION }}"
          echo "编译模式: ${{ github.event.inputs.BUILD_METHOD }}"
          echo "自定义后缀: ${{ github.event.inputs.SUFFIX }}"
          echo "启用VFS: ${{ github.event.inputs.VFS }}"
          echo "启用ZRAM扩展: ${{ github.event.inputs.ZRAM }}"
          echo "快速编译模式: ${{ github.event.inputs.FAST }}"
          echo "集成选项: ${{ github.event.inputs.INTEGRATE_OPTION }}"

      - name: 获取内核源码
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          git clone --depth=1 https://github.com/kquieter-debug/android_kernel_oneplus_mt6897 -b oneplus/mt6897_v_15.0.0_oneplus_pad
          mv android_kernel_oneplus_mt6897 kernel
          echo "内核源码获取完成"

      - name: 清理版本标识
        run: |
          cd kernel_workspace/kernel
          sed -i 's/ -dirty//g' scripts/setlocalversion || true
          sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' scripts/setlocalversion

      - name: 全局清理 oplus 相关无效 Kconfig 引用
        run: |
          cd kernel_workspace/kernel
          echo "开始全局搜索并清理 oplus 相关无效 Kconfig 引用..."
          # 1. 搜索所有 Kconfig 文件中包含 "oplus" 的引用行
          SEARCH_RESULT=$(grep -r "source.*oplus" --include="Kconfig*" .)
          if [ -z "$SEARCH_RESULT" ]; then
            echo "未找到 oplus 相关无效引用"
          else
            echo "找到以下无效引用，开始清理："
            echo "$SEARCH_RESULT"
            # 2. 批量删除所有包含 "source.*oplus" 的行（使用 ; 分隔多个文件操作）
            grep -r "source.*oplus" --include="Kconfig*" . | awk -F: '{print $1}' | sort -u | while read -r file; do
              sed -i '/source.*oplus/d' "$file"
              echo "已清理文件: $file"
            done
          fi
          echo "全局清理完成！"

      - name: 设置自定义版本后缀
        if: ${{ github.event.inputs.SUFFIX != '' }}
        run: |
          cd kernel_workspace/kernel
          sed -i '/^res=/a res=$(echo "$res" | sed -E '\''s/-[0-9]+-o-g[0-9a-f]{7,}//'\'')' scripts/setlocalversion
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          if [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "仅集成 SukiSU-ultra" ]; then
            SUFFIX="${SUFFIX}-KSU${{ env.KSUVER }}"
          elif [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "集成 SUSFS 功能" ]; then
            SUFFIX="${SUFFIX}-SUSFS"
          fi
          sed -i "\$s|echo \"\\\$res\"|echo \"\$res-$SUFFIX\"|" scripts/setlocalversion

      - name: 生成随机版本后缀
        if: ${{ github.event.inputs.SUFFIX == '' }}
        run: |
          cd kernel_workspace/kernel
          RANDOM_DIGIT=$(od -An -N1 -tu1 < /dev/urandom | tr -d '[:space:]' | awk '{print $1 % 11}')
          RANDOM_HASH=$(od -An -N7 -tx1 /dev/urandom | tr -d ' \n')
          RANDOM_SUFFIX="${RANDOM_DIGIT}-o-g${RANDOM_HASH}"
          if [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "仅集成 SukiSU-ultra" ]; then
            RANDOM_SUFFIX="${RANDOM_SUFFIX}-KSU${{ env.KSUVER }}"
          elif [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "集成 SUSFS 功能" ]; then
            RANDOM_SUFFIX="${RANDOM_SUFFIX}-SUSFS"
          fi
          sed -i '/^res=/a res=$(echo "$res" | sed -E '\''s/-[0-9]+-o-g[0-9a-fA-F]{7,}//g'\'')' scripts/setlocalversion || true
          sed -i "\$s|echo \"\\\$res\"|echo \"\$res-$RANDOM_SUFFIX\"|" scripts/setlocalversion || true

      - name: 集成 SukiSU-ultra 核心
        if: ${{ github.event.inputs.INTEGRATE_OPTION == '仅集成 SukiSU-ultra' }}
        run: |
          echo "开始集成 SukiSU-ultra 核心..."
          cd kernel_workspace/kernel
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          cd ./KernelSU*
          KSU_VERSION=$(expr $(/usr/bin/git rev-list --count main) "+" 10606)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "SukiSU-ultra 核心集成完成。"

      - name: 集成 SUSFS 功能（修复语法错误）
        if: ${{ github.event.inputs.INTEGRATE_OPTION == '集成 SUSFS 功能' }}
        run: |
          echo "开始集成 SUSFS 功能..."
          cd kernel_workspace/kernel
          # 使用 main 分支兼容（SukiSU-Ultra 无 susfs-dev 分支）
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          # 修正 Makefile 语法错误
          echo "CONFIG_SUSFS=y" >> drivers/Kconfig
          echo "obj-y += susfs/" >> drivers/Makefile
          echo "SUSFS 功能集成完成。"

      - name: 配置内核选项
        run: |
          cd kernel_workspace/kernel
          CONFIG_FILE=arch/arm64/configs/oneplus6897_defconfig

          if [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "仅集成 SukiSU-ultra" ]; then
            echo "配置 KernelSU 相关选项..."
            echo "CONFIG_KSU=y" >> "$CONFIG_FILE"
            echo "CONFIG_OVERLAY_FS=y" >> "$CONFIG_FILE"
            echo "CONFIG_KPROBES=y" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_WITH_KPROBES=y" >> "$CONFIG_FILE"
          elif [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "集成 SUSFS 功能" ]; then
            echo "配置 SUSFS 相关选项..."
            echo "CONFIG_SUSFS=y" >> "$CONFIG_FILE"
            echo "CONFIG_FUSE_FS=y" >> "$CONFIG_FILE"
          fi

          if [ "${{ github.event.inputs.ZRAM }}" = "true" ]; then
            echo "CONFIG_ZRAM_DEF_COMP=\"zstd\"" >> "$CONFIG_FILE"
            echo "CONFIG_ZRAM_DEF_COMP_ZSTD=y" >> "$CONFIG_FILE"
            echo "CONFIG_CRYPTO_ZRAM=y" >> "$CONFIG_FILE"
            echo "CONFIG_ZRAM_MULTI_COMP=y" >> "$CONFIG_FILE"
          fi

      - name: 编译内核
        run: |
          cd kernel_workspace/kernel
          export PATH="/usr/lib/ccache:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export DTC_EXT=dtc
          
          if [ "${{ github.event.inputs.FAST }}" = "true" ]; then
            BUILD_TARGET="Image"
          else
            BUILD_TARGET="all"
          fi

          # 执行 defconfig 生成配置文件（已全局清理无效引用）
          make O=out oneplus6897_defconfig
          
          # 执行编译，预留 CPU 核心防止崩溃
          make -j$(($(nproc --all) - 2)) O=out \
            CC="clang-20" \
            LD="ld.lld-20" \
            AR="llvm-ar-20" \
            NM="llvm-nm-20" \
            OBJCOPY="llvm-objcopy-20" \
            OBJDUMP="llvm-objdump-20" \
            STRIP="llvm-strip-20" \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            $BUILD_TARGET

          # 校验并整理编译输出
          mkdir -p ../dist
          if [ -f "out/arch/arm64/boot/Image" ]; then
            cp out/arch/arm64/boot/Image ../dist/Image
            echo "内核编译完成，Image 文件已生成"
          else
            echo "错误：未找到编译生成的 Image 文件，编译失败！"
            exit 1
          fi

      - name: 准备AnyKernel3刷机包
        run: |
          git clone https://github.com/Numbersf/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          if [ -f "kernel_workspace/dist/Image" ]; then
            cp kernel_workspace/dist/Image ./AnyKernel3/Image
            echo "AnyKernel3 刷机包准备完成"
          else
            echo "错误：无法找到 Image 文件，刷机包准备失败！"
            exit 1
          fi

      - name: 生成刷机包后缀
        id: suffix
        run: |
          BASE_SUFFIX=""
          [ "${{ github.event.inputs.VFS }}" = "true" ] && BASE_SUFFIX+="_VFS"
          [ "${{ github.event.inputs.ZRAM }}" = "true" ] && BASE_SUFFIX+="_ZSTD"

          if [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "仅集成 SukiSU-ultra" ]; then
            echo "value=${BASE_SUFFIX}_KSU${{ env.KSUVER }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.INTEGRATE_OPTION }}" = "集成 SUSFS 功能" ]; then
            echo "value=${BASE_SUFFIX}_SUSFS" >> $GITHUB_OUTPUT
          fi

      - name: 上传刷机包
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_OneplusPad_MT6897${{ steps.suffix.outputs.value }}
          path: ./AnyKernel3/*
